---
title: "【勉強会メモ】【大阪】カイゼンNight 運用トラブル編 / RAKUS Meetup Osaka"
description: "ミートアップに参加しました。"
date: "2019-09-18"
tags: "勉強会メモ"
---

## 【大阪】カイゼンNight 運用トラブル編 / RAKUS Meetup Osaka

株式会社ラクス様主催のカイゼンNight 運用トラブル編　というイベントに参加した勉強会メモです。

## IPレピュテーション改善奮闘記

野々村さん

> メールの配信到達率にはIPレピュテーション(評価)が影響します。可視化されているIPレピュテーションの改善/分析活動と今までのキャリアによる配信ブロックに対するインフラチームの対応をご紹介します。

インフラチームが行なっている施策とトラブル事例について

## 配配メールとは

メルマガ配信・一斉メール配信サービス

## IPレピュテーションって何？

IPアドレスの評判を評価し、

IPレピュテーションを上げておくことで配信到達率の向上に繋がる

優良IPと違反IPと言うものがある

### 配信到達率？

配信先ユーザのサーバにメールが届くこと

### IPアドレスが低いと？

受信ブロックが発生したり、迷惑メールとして処理される可能性がある

### サポート/ 開発側での背策

- ガイドライン作成
- メール到達率の見えるか
- ポリシー違反コンテンツのチェック

### どんなことをしているのか？

4つ取り組まれているが2つは検証中とのこと
検証中でないものは次の2つ

- 隔離環境の構築/整備
- IPレピュテーション解析

### 隔離環境の構築/整備

通常顧客配信環境とコンテンツ違反顧客配信環境に分け
違反があったらサポートチームから連絡し、カイゼンされないなら
コンテンツ違反顧客配信環境に移動させる

Google Postmaster Toolを使用すればドメインに基づくIPアドレスの評価を確認することができる

1IPに対してメール送信数が多ければIPレピュテーションが下がる

NGっぽいワードを含んだ配信で評価が下がったか？
など色々分けて調べる

IPウォームアップ => レピュテーションがない状態から高めること

新しいIPアドレスには評価がついていないのでウォームアップしてIPアドレスの評価を高める必要がある

### 対策の効果は？

メール不達問い合わせ件数　1年半弱で約50%削減

uoIPレピュテーションが改善し到達率が上がったと言える

### ある日のトラブル

IPレピュテーションが急に悪くなった

問題になりそうなものを色々と洗い出して分析してみた
レピュテーションが下がったサーバに関連性はなく
翌日から改善した

## 最後に

メールの配信到達に関しては配信先サーバに大きく依存します
メール配信サービスの基本、メールが届くようにします
(ちょっと書ききれず原文ママではありません・・・)

## アクセス数もクリック数も急激に増加！？メール配信サービスの謎の怪奇現象

Nhanさん

> ある日、配配メールのサポート窓口に「クリック数の計測値がありえないほど増えている」という問い合わせが来ました。
また、別の日には運用チームが「通常では考えられないほどのアクセス集中」を検知しました。
これらの謎の現象に立ち向かった配配メール開発チームのちょっと怖いトラブルエピソードをお伝えします。

配配メール

### どの機能でトラブルが発生したのか？

効果測定機能で発生した

### 効果測定とは？

- 配信成功数/失敗数
- クリック率
- 開封率

からなるデータ

クリックした顧客、してない顧客などわかる

### 謎の怪奇現象

通常では考えられないほどのアクセス集中
サポート窓口にクリック数の計測値がありえないほど増えていると連絡あり

### クリック/開封カウントの構造

メール受信側でのメール開封などが確認できる

### 原因調査

- 短期間に大量アクセス
- 1秒以内に連続アクセス

1秒間に数十回連続クリックは人間の技ではないと考え、
機械的なアクセスに酔っているのでは？？

### 対策

1.除外対象IPを設定
1.集計を除外
1.除外対象IPからのアクセスをリダイレクト

機械的にアクセスしているであろうIPを省いたり

### どうやって作成？

ユーザーエージェント(UA)で判別

ブラウザと同じUAでアクセスする場合もあり対策が失敗

### Apache Module mod_rewrite

これでリダイレクトさせる

### 効果

データが正しくなったと連絡があった・もらえた

### 課題

除外対象IPを日々作成する必要がある

### まとめ

メール配信サービスでは想定外のトラブルがよく発生する
トラブル発生により大変なこと、難しいことがある
運用面は主導の作業があって手間がかかる

## メールディーラー、長い長い戦いの歴史

中尾さん

> クラウドやSaaSという言葉が認知度を高めるもっと以前から提供されていたメールディーラー。
クラウド時代の荒波とともに幾多のトラブルも乗り越えてきました。
メールディーラーの開発に関わった歴戦の勇士たちから聞き集めた数々のトラブルと、それらをどうやって解決していったのかをご紹介します。

### ビーレジェンドプロテイン　ミルキー味

美味しい

### バージョンアップしたら画面が真っ白に

メジャーアップデート後に、
特定の環境と画面で真っ白になってしまうとサポートチームへ報告あり

たくさん結合テストしたのに・・・・

さらに別の環境ではログイン後真っ白に

ループの中でとても長い配列など作りメモリ不足に？

エラーメッセージからメモリオーバーが発生していることは間違いない

プログラムの通りmitにメモリの利用状況をログに吐き出すようひたすら埋め込みデバッグ

### 原因

pg\_field\_type関数

<https://www.php.net/manual/ja/function.pg-field-type.php>

フィールド番号に対応する関数

カラムの型を取得する関数

パフォーマンス的に問題があったので新しく代わる関数を作り稼働させた

### PHPのファイルがNot Found

Not Foundとエラーが出るのでそのファイルが存在しているのか確認

バージョンアップが原因っぽい

シンボリックリンクで対応しようとするもまた出る

仮説を立てる

straceでコマンドを実行してプロセスの挙動を追いかける

### 最後のまとめ

古くから稼働しているサービスで今まで問題がなくても急に問題が表面化することがある

今までずっと大丈夫だったからと思い込まないことが大事

かといって最初から後々のことを考えてしまってもいけないのでバランスを考えることが大事

## 感想

今日も実際の企業様のお話をたくさん聞けて楽しかったです。前回のミートアップでもメール配信率に関するお話はされており、ある程度すんなりと頭の中に入ってくるところもありました。

個人的には最後のメールディーラーに関する長い長い戦いの歴史のお話が特に面白く、エラーが出た時の地道なデバッグや仮説を立てて検証していく過程が共感と関心を持てました。

理由はちょうど本日、自分が作ったプログラムで今までは問題なく動いていたがなぜか動かないみたいな状態に直面し、地道なデバッグと仮説・検証の作業を行ったからですが・・・！

そのような感じで、実際のWebサービス運営に関するお話を知ることが出来て貴重な経験をできました。いつも参加させて頂いていますが、また機会が合えば参加させてもらいたいなと思います。ありがとうございました。
